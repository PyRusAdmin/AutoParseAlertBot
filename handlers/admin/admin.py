# -*- coding: utf-8 -*-
from aiogram import F
from aiogram.fsm.context import FSMContext
from aiogram.types import Message

from database.database import TelegramGroup
from keyboards.admin.keyboards import admin_keyboard
from system.dispatcher import router
from loguru import logger  # https://github.com/Delgan/loguru


@router.message(F.text == "Панель администратора")
async def admin_panel(message: Message, state: FSMContext):
    """
    Обработчик команды «Панель администратора».

    При вызове:
    - сбрасывает текущее состояние FSM;
    - отправляет приветственное сообщение администратору;
    - отображает клавиатуру с административными кнопками.

    Используется для:
    - предоставления доступа к административному интерфейсу;
    - запуска административных операций через клавиатурные кнопки.

    Особенности реализации:
    - Команда доступна всем пользователям — в продакшен‑среде необходимо ограничить доступ только для авторизованных администраторов;
    - обработка исключений не реализована: возможные ошибки (например, при формировании клавиатуры) не перехватываются и могут привести к аварийному завершению обработчика.

    :param message: (Message) Входящее сообщение с командой «Панель администратора».
    :param state: (FSMContext) Контекст машины состояний. Сбрасывается в начале выполнения.
    :return: None
    :raises:
        Exception: Может возникнуть при:
        - ошибках формирования клавиатуры (admin_keyboard());
        - проблемах при отправке сообщения через Telegram Bot API.
        В текущей реализации исключения не обрабатываются.
    """
    try:
        await state.clear()  # Сбрасываем текущее состояние FSM

        text = (
            "Рад видеть тебя снова, администратор!\n"
            "На кнопке 'Получить лог файл' ты можешь получить лог файл с ошибками бота.\n"
            "На кнопке 'Актуализация базы данных' ты можешь актуализировать базу данных (проверить на сущность Группа или Канал)."
        )
        await message.answer(
            text=text,
            parse_mode="HTML",
            reply_markup=admin_keyboard(),
        )
    except Exception as e:
        logger.exception(e)


@router.message(F.text == "Актуализация базы данных")
async def update_db(message: Message):
    """Актуализация базы данных на группу или канал"""

    # 1. Считываем с базы данных данные

    # Получаем все записи
    all_groups = TelegramGroup.select()
    # Перебираем все записи
    for group in all_groups:
        # Выводим полученные данные
        logger.info(group.name, group.username)


def register_handlers_admin_panel():
    """
    Регистрирует обработчик команды «Панель администратора» в маршрутизаторе.

    Добавляет в router обработчик для команды, активируемой по тексту «Панель администратора».
    Обеспечивает запуск функции admin_panel при получении соответствующего сообщения.

    Рекомендации по безопасности:
    - В текущей реализации команда доступна любому пользователю;
    - в продакшене необходимо добавить проверку прав доступа (например, по списку разрешённых user_id);
    - рекомендуется реализовать обработку возможных исключений.

    :return: None
    """
    router.message.register(admin_panel)  # Админ панель
    router.message.register(update_db)  # Актуализация базы данных (c пометкой Группа или Канал)
